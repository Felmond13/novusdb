<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovusDB â€” Employee Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 font-sans min-h-screen">
<div id="root"></div>
<script type="text/babel">
const API = '';

function useApi(url, deps = []) {
    const [data, setData] = React.useState(null);
    const [loading, setLoading] = React.useState(true);
    const refresh = React.useCallback(() => {
        setLoading(true);
        fetch(API + url).then(r => r.json()).then(d => { setData(d); setLoading(false); }).catch(() => setLoading(false));
    }, [url, ...deps]);
    React.useEffect(() => { refresh(); }, [refresh]);
    return { data, loading, refresh };
}

function App() {
    const [tab, setTab] = React.useState('dashboard');
    const [refreshKey, setRefreshKey] = React.useState(0);
    const bump = () => setRefreshKey(k => k + 1);

    return (
        <div className="max-w-7xl mx-auto px-4 py-6">
            <Header />
            <Nav tab={tab} setTab={setTab} />
            <div className="mt-6 fade-in" key={tab + refreshKey}>
                {tab === 'dashboard' && <Dashboard key={refreshKey} />}
                {tab === 'employees' && <Employees onMutate={bump} key={refreshKey} />}
                {tab === 'sql' && <SQLConsole />}
            </div>
        </div>
    );
}

function Header() {
    return (
        <div className="flex items-center gap-4 mb-2">
            <div className="w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center font-bold text-xl">N</div>
            <div>
                <h1 className="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">NovusDB</h1>
                <p className="text-sm text-gray-500">Employee Dashboard â€” Powered by a single-file embedded database</p>
            </div>
        </div>
    );
}

function Nav({ tab, setTab }) {
    const tabs = [
        { id: 'dashboard', label: 'Dashboard', icon: 'ðŸ“Š' },
        { id: 'employees', label: 'Employees', icon: 'ðŸ‘¥' },
        { id: 'sql', label: 'SQL Console', icon: 'âš¡' },
    ];
    return (
        <div className="flex gap-1 bg-gray-900 rounded-xl p-1 mt-4">
            {tabs.map(t => (
                <button key={t.id} onClick={() => setTab(t.id)}
                    className={`flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all ${tab === t.id ? 'bg-gray-800 text-white shadow-lg' : 'text-gray-400 hover:text-gray-200'}`}>
                    {t.icon} {t.label}
                </button>
            ))}
        </div>
    );
}

function Dashboard() {
    const { data, loading } = useApi('/api/stats');
    if (loading) return <Loader />;
    if (!data) return <p>Error loading stats</p>;

    const total = data.total?.count || 0;
    const avgSal = data.avg_salary?.value || 0;
    const cities = data.by_city || [];
    const depts = data.by_department || [];
    const top = data.top_earners || [];

    return (
        <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <StatCard label="Total Employees" value={total.toLocaleString()} icon="ðŸ‘¥" color="cyan" />
                <StatCard label="Avg. Salary" value={`â‚¬${Math.round(avgSal).toLocaleString()}`} icon="ðŸ’°" color="green" />
                <StatCard label="Cities" value={cities.length} icon="ðŸ™ï¸" color="purple" />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Card title="Employees by City">
                    <BarChart data={cities.map(c => ({ label: c.city, value: c.count }))} color="bg-cyan-500" />
                </Card>
                <Card title="Employees by Department">
                    <BarChart data={depts.map(d => ({ label: d.department, value: d.count }))} color="bg-blue-500" />
                </Card>
            </div>

            <Card title="Top 5 Earners">
                <table className="w-full text-sm">
                    <thead><tr className="text-gray-500 text-left">
                        <th className="pb-2">Name</th><th className="pb-2">Department</th><th className="pb-2 text-right">Salary</th>
                    </tr></thead>
                    <tbody>
                        {top.map((e, i) => (
                            <tr key={i} className="border-t border-gray-800">
                                <td className="py-2 font-medium">{e.first_name} {e.last_name}</td>
                                <td className="py-2 text-gray-400">{e.department}</td>
                                <td className="py-2 text-right text-green-400 font-mono">â‚¬{Math.round(e.salary).toLocaleString()}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </Card>
        </div>
    );
}

function Employees({ onMutate }) {
    const [search, setSearch] = React.useState('');
    const [field, setField] = React.useState('city');
    const { data, loading, refresh } = useApi(`/api/employees?limit=50&sort=last_name&order=ASC`);
    const [results, setResults] = React.useState(null);
    const [adding, setAdding] = React.useState(false);

    const doSearch = () => {
        if (!search.trim()) { setResults(null); return; }
        fetch(API + `/api/employees/search?q=${encodeURIComponent(search)}&field=${field}`)
            .then(r => r.json()).then(d => setResults(d));
    };

    const doDelete = (fn, ln) => {
        if (!confirm(`Delete ${fn} ${ln}?`)) return;
        fetch(API + `/api/employees/delete?first_name=${fn}&last_name=${ln}`, { method: 'DELETE' })
            .then(() => { refresh(); onMutate(); setResults(null); });
    };

    const rows = results ? results.rows : (data?.rows || []);
    const timeMs = results ? results.time_ms : (data?.time_ms || 0);

    return (
        <div className="space-y-4">
            <div className="flex gap-2 items-center">
                <select value={field} onChange={e => setField(e.target.value)}
                    className="bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                    <option value="city">City</option>
                    <option value="department">Department</option>
                    <option value="first_name">First Name</option>
                    <option value="last_name">Last Name</option>
                </select>
                <input value={search} onChange={e => setSearch(e.target.value)} onKeyDown={e => e.key === 'Enter' && doSearch()}
                    placeholder="Search..." className="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:border-cyan-500 focus:outline-none" />
                <button onClick={doSearch} className="bg-cyan-600 hover:bg-cyan-500 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Search</button>
                <button onClick={() => { setResults(null); setSearch(''); }} className="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm transition-colors">Clear</button>
                <button onClick={() => setAdding(!adding)} className="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg text-sm font-medium transition-colors">+ Add</button>
            </div>

            {adding && <AddForm onDone={() => { setAdding(false); refresh(); onMutate(); }} />}

            <div className="text-xs text-gray-500">{rows?.length || 0} results â€” query time: {timeMs?.toFixed(2)}ms</div>

            {loading ? <Loader /> : (
                <div className="bg-gray-900 rounded-xl overflow-hidden">
                    <table className="w-full text-sm">
                        <thead><tr className="text-gray-500 text-left text-xs uppercase">
                            <th className="px-4 py-3">Name</th><th className="px-4 py-3">City</th><th className="px-4 py-3">Dept</th>
                            <th className="px-4 py-3">Age</th><th className="px-4 py-3 text-right">Salary</th><th className="px-4 py-3"></th>
                        </tr></thead>
                        <tbody>
                            {(rows || []).map((e, i) => (
                                <tr key={i} className="border-t border-gray-800 hover:bg-gray-800/50 transition-colors">
                                    <td className="px-4 py-2.5 font-medium">{e.first_name} {e.last_name}</td>
                                    <td className="px-4 py-2.5 text-gray-400">{e.city}</td>
                                    <td className="px-4 py-2.5"><span className="bg-gray-800 px-2 py-0.5 rounded text-xs">{e.department}</span></td>
                                    <td className="px-4 py-2.5 text-gray-400">{e.age}</td>
                                    <td className="px-4 py-2.5 text-right font-mono text-green-400">â‚¬{Math.round(e.salary).toLocaleString()}</td>
                                    <td className="px-4 py-2.5 text-right">
                                        <button onClick={() => doDelete(e.first_name, e.last_name)} className="text-red-500 hover:text-red-400 text-xs">âœ•</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
}

function AddForm({ onDone }) {
    const [form, setForm] = React.useState({ first_name: '', last_name: '', city: 'Paris', department: 'Engineering', age: 30, salary: 50000 });
    const set = (k, v) => setForm({ ...form, [k]: v });

    const submit = () => {
        fetch(API + '/api/employees/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(form) })
            .then(r => r.json()).then(() => onDone());
    };

    return (
        <div className="bg-gray-900 rounded-xl p-4 grid grid-cols-2 md:grid-cols-6 gap-3 fade-in">
            <input placeholder="First name" value={form.first_name} onChange={e => set('first_name', e.target.value)} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm" />
            <input placeholder="Last name" value={form.last_name} onChange={e => set('last_name', e.target.value)} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm" />
            <input placeholder="City" value={form.city} onChange={e => set('city', e.target.value)} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm" />
            <input placeholder="Department" value={form.department} onChange={e => set('department', e.target.value)} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm" />
            <input type="number" placeholder="Age" value={form.age} onChange={e => set('age', parseInt(e.target.value))} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm" />
            <button onClick={submit} className="bg-green-600 hover:bg-green-500 rounded-lg text-sm font-medium transition-colors">Save</button>
        </div>
    );
}

function SQLConsole() {
    const [sql, setSql] = React.useState('SELECT city, COUNT(*) AS count, AVG(salary) AS avg_salary\nFROM employees\nGROUP BY city');
    const [result, setResult] = React.useState(null);
    const [error, setError] = React.useState('');

    const run = () => {
        setError('');
        fetch(API + '/api/query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sql }) })
            .then(r => r.json()).then(d => { if (d.error) setError(d.error); else setResult(d); }).catch(e => setError(e.message));
    };

    const examples = [
        'SELECT * FROM employees LIMIT 10',
        'SELECT COUNT(*) AS total FROM employees',
        'SELECT city, COUNT(*) AS count FROM employees GROUP BY city',
        'SELECT department, AVG(salary) AS avg FROM employees GROUP BY department',
        'SELECT first_name, last_name, salary FROM employees WHERE salary > 90000 ORDER BY salary DESC LIMIT 5',
        'SELECT UPPER(first_name) AS name, city FROM employees WHERE department = "Engineering" LIMIT 5',
    ];

    const cols = result?.rows?.length > 0 ? Object.keys(result.rows[0]) : [];

    return (
        <div className="space-y-4">
            <Card title="SQL Console">
                <textarea value={sql} onChange={e => setSql(e.target.value)} rows={4}
                    className="w-full bg-gray-950 border border-gray-700 rounded-lg px-4 py-3 font-mono text-sm text-cyan-300 focus:border-cyan-500 focus:outline-none resize-y"
                    onKeyDown={e => { if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); run(); } }} />
                <div className="flex gap-2 mt-3">
                    <button onClick={run} className="bg-cyan-600 hover:bg-cyan-500 px-5 py-2 rounded-lg text-sm font-medium transition-colors">
                        â–¶ Run (Ctrl+Enter)
                    </button>
                    {result && <span className="text-xs text-gray-500 self-center">{result.count} rows â€” {result.time_ms?.toFixed(2)}ms</span>}
                </div>
                {error && <p className="text-red-400 text-sm mt-2">{error}</p>}
            </Card>

            <div className="flex flex-wrap gap-2">
                {examples.map((ex, i) => (
                    <button key={i} onClick={() => setSql(ex)}
                        className="bg-gray-900 hover:bg-gray-800 border border-gray-800 px-3 py-1.5 rounded-lg text-xs text-gray-400 hover:text-white transition-colors truncate max-w-xs">
                        {ex}
                    </button>
                ))}
            </div>

            {result?.rows?.length > 0 && (
                <div className="bg-gray-900 rounded-xl overflow-auto fade-in">
                    <table className="w-full text-sm">
                        <thead><tr className="text-gray-500 text-left text-xs uppercase">
                            {cols.map(c => <th key={c} className="px-4 py-3">{c}</th>)}
                        </tr></thead>
                        <tbody>
                            {result.rows.map((row, i) => (
                                <tr key={i} className="border-t border-gray-800">
                                    {cols.map(c => <td key={c} className="px-4 py-2 font-mono text-gray-300">{typeof row[c] === 'number' ? (Number.isInteger(row[c]) ? row[c].toLocaleString() : row[c].toFixed(2)) : String(row[c])}</td>)}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
}

// ---------- UI Components ----------

function StatCard({ label, value, icon, color }) {
    const colors = { cyan: 'from-cyan-500/20 to-cyan-500/5 border-cyan-500/30', green: 'from-green-500/20 to-green-500/5 border-green-500/30', purple: 'from-purple-500/20 to-purple-500/5 border-purple-500/30' };
    return (
        <div className={`bg-gradient-to-br ${colors[color]} border rounded-xl p-5`}>
            <div className="text-2xl mb-1">{icon}</div>
            <div className="text-3xl font-bold">{value}</div>
            <div className="text-sm text-gray-400 mt-1">{label}</div>
        </div>
    );
}

function Card({ title, children }) {
    return (
        <div className="bg-gray-900 rounded-xl p-5">
            {title && <h3 className="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">{title}</h3>}
            {children}
        </div>
    );
}

function BarChart({ data, color }) {
    const max = Math.max(...data.map(d => d.value), 1);
    return (
        <div className="space-y-2">
            {data.map((d, i) => (
                <div key={i} className="flex items-center gap-3">
                    <span className="text-xs text-gray-400 w-28 text-right truncate">{d.label}</span>
                    <div className="flex-1 bg-gray-800 rounded-full h-5 overflow-hidden">
                        <div className={`${color} h-full rounded-full transition-all duration-500`} style={{ width: `${(d.value / max) * 100}%` }}></div>
                    </div>
                    <span className="text-xs font-mono text-gray-300 w-12">{d.value}</span>
                </div>
            ))}
        </div>
    );
}

function Loader() {
    return <div className="flex justify-center py-12"><div className="w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div></div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
